<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python & React Chatbot</title>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react?dev",
      "react-dom/client": "https://esm.sh/react-dom/client?dev"
    }
  }
  </script>
<style>
  :root {
    --primary-color: #6366f1;
    --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bot-msg-bg: #ffffff;
    --user-msg-bg: #6366f1;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body { 
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    background: var(--bg-gradient);
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 15px;
  }

  /* Glassmorphism Container */
  #chat-container { 
    width: 100%; 
    max-width: 450px; 
    height: 85vh;
    max-height: 800px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 24px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    display: flex; 
    flex-direction: column; 
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  /* Header */
  .chat-header {
    padding: 20px;
    background: white;
    text-align: center;
    border-bottom: 1px solid #eee;
  }
  .chat-header h2 { font-size: 1.1rem; color: #1f2937; font-weight: 700; }
  .status-dot { height: 8px; width: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 5px; }

  /* Messages Area */
  #messages-area { 
    flex: 1; 
    padding: 20px; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 12px;
    background: rgba(249, 250, 251, 0.5);
  }

  .message { 
    max-width: 80%; 
    padding: 12px 16px; 
    border-radius: 16px; 
    font-size: 14px; 
    line-height: 1.5;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .user { 
    background: var(--user-msg-bg);
    color: white; 
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  }

  .bot { 
    background: var(--bot-msg-bg);
    color: #374151; 
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border: 1px solid #e5e7eb;
  }

  /* Input Area */
  #input-area { 
    padding: 20px; 
    background: white;
    display: flex; 
    gap: 10px;
    align-items: center;
  }

  input { 
    flex: 1; 
    padding: 12px 18px; 
    border: 1px solid #e5e7eb; 
    border-radius: 12px; 
    outline: none; 
    font-size: 15px;
    transition: border 0.2s;
  }
  input:focus { border-color: var(--primary-color); }

  button.send-btn { 
    background: var(--primary-color);
    color: white; 
    border: none; 
    width: 45px;
    height: 45px;
    border-radius: 12px; 
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, background 0.2s;
  }
  button.send-btn:hover { transform: scale(1.05); background: #4f46e5; }

  .clear-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.4);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    backdrop-filter: blur(5px);
  }
  
  /* Scrollbar */
  #messages-area::-webkit-scrollbar { width: 4px; }
  #messages-area::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';

    const API_BASE_URL = "https://sotch13-ai-chatbot-assistant.hf.space";

    function TypewriterText({ text }) {
      const [displayedText, setDisplayedText] = React.useState("");
      React.useEffect(() => {
        let i = 0;
        const timer = setInterval(() => {
          setDisplayedText((prev) => prev + text.charAt(i));
          i++;
          if (i >= text.length) clearInterval(timer);
        }, 20);
        return () => clearInterval(timer);
      }, [text]);
      return <span>{displayedText}</span>;
    }
    
    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isTyping, setIsTyping] = useState(false);
      const [isLoadingHistory, setIsLoadingHistory] = useState(true);
      const messagesEndRef = useRef(null);

      // --- NEW: Î¦ÎŸÎ¡Î¤Î©Î£Î— Î™Î£Î¤ÎŸÎ¡Î™ÎšÎŸÎ¥ Î‘Î ÎŸ SUPABASE ÎœÎ•Î£Î© Î¤ÎŸÎ¥ BACKEND ---
      useEffect(() => {
        const fetchHistory = async () => {
          try {
            const res = await fetch(API_BASE_URL);
            const data = await res.json();
            if (data.history && data.history.length > 0) {
              const loadedMessages = data.history.map(m => ({
                sender: m.role === "user" ? "user" : "bot",
                text: m.content
              }));
              setMessages(loadedMessages);
            } else {
              setMessages([{ sender: "bot", text: "Î“ÎµÎ¹Î±! Î”ÎµÎ½ Î²ÏÎ®ÎºÎ± Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î± Î¼Î·Î½ÏÎ¼Î±Ï„Î±. Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰;" }]);
            }
          } catch (err) {
            console.error("Error loading history:", err);
            setMessages([{ sender: "bot", text: "ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚! (Î¤Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®)" }]);
          } finally {
            setIsLoadingHistory(false);
          }
        };
        fetchHistory();
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [messages]);

      const sendMessage = async () => {
        if (!input.trim() || isTyping) return;
        const userMsg = { sender: "user", text: input };
        setMessages(prev => [...prev, userMsg]);
        const currentInput = input;
        setInput("");
        setIsTyping(true);

        try {
          const response = await fetch(`${API_BASE_URL}/api/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: currentInput })
          });
          const data = await response.json();
          setMessages(prev => [...prev, { sender: "bot", text: data.reply }]);
        } catch (error) {
          setMessages(prev => [...prev, { sender: "bot", text: "âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚!" }]);
        } finally {
          setIsTyping(false);
        }
      };

      const clearChat = async () => {
        if(!confirm("Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÏƒÎ²Î®ÏƒÎµÎ¹Ï‚ ÏŒÎ»Î¿ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·;")) return;
        try {
          await fetch(`${API_BASE_URL}/api/clear`, { method: 'POST' });
          setMessages([{ sender: "bot", text: "Î¤Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ!" }]);
        } catch (e) { alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®."); }
      };

      return (
      <React.Fragment>
        <button className="clear-btn" onClick={clearChat}>ğŸ—‘ï¸ Clear Space</button>
        <div id="chat-container">
          <div className="chat-header">
            <h2><span className="status-dot"></span> AI Assistant</h2>
          </div>
            
            <div id="messages-area">
              {isLoadingHistory ? (
                <div style={{textAlign: 'center', color: '#999', marginTop: '20px'}}>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï...</div>
              ) : (
                messages.map((msg, index) => (
                  <div key={index} className={`message ${msg.sender}`}>
                    {msg.sender === "bot" && index === messages.length - 1 && !isLoadingHistory ? (
                      <TypewriterText text={msg.text} />
                    ) : (
                      msg.text
                    )}
                  </div>
                ))
              )}
              <div ref={messagesEndRef} />
            </div>
            
            <div id="input-area">
              <input 
                value={input} 
                disabled={isTyping || isLoadingHistory}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                placeholder={isTyping ? "Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ..." : "ÎœÎ®Î½Ï…Î¼Î±..."}
              />
              <button className="send-btn" onClick={sendMessage} disabled={isTyping || !input.trim() || isLoadingHistory}>
                {isTyping ? "..." : "Î£Ï„ÎµÎ¯Î»Îµ"}
              </button>
            </div>
          </div>
        </React.Fragment>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>