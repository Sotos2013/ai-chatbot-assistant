<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python & React Chatbot</title>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react?dev",
      "react-dom/client": "https://esm.sh/react-dom/client?dev"
    }
  }
  </script>
  <style>
    /* CSS Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î¯Î´Î¹Î¿ Î¼Îµ Ï„Î¿ responsive Ï€Î¿Ï… Ï†Ï„Î¹Î¬Î¾Î±Î¼Îµ Ï€ÏÎ¹Î½ */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 10px; }
    #chat-container { width: 100%; max-width: 500px; height: 80vh; max-height: 700px; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; background: #f9f9f9; }
    #messages-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { max-width: 85%; padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
    .user { background: linear-gradient(135deg, #0084ff, #00a2ff); color: white; align-self: flex-end; }
    .bot { background: #ffffff; color: #333; align-self: flex-start; border: 1px solid #e4e6eb; }
    #input-area { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white; }
    input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 16px; }
    button.send-btn { background: #0084ff; color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .clear-btn { margin-bottom: 10px; padding: 8px 16px; border-radius: 10px; border: 1px solid #ddd; background: white; cursor: pointer; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';

    const API_BASE_URL = "https://sotch13-ai-chatbot-assistant.hf.space";

    function TypewriterText({ text }) {
      const [displayedText, setDisplayedText] = React.useState("");
      React.useEffect(() => {
        let i = 0;
        const timer = setInterval(() => {
          setDisplayedText((prev) => prev + text.charAt(i));
          i++;
          if (i >= text.length) clearInterval(timer);
        }, 20);
        return () => clearInterval(timer);
      }, [text]);
      return <span>{displayedText}</span>;
    }
    
    function App() {
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isTyping, setIsTyping] = useState(false);
      const [isLoadingHistory, setIsLoadingHistory] = useState(true);
      const messagesEndRef = useRef(null);

      // --- NEW: Î¦ÎŸÎ¡Î¤Î©Î£Î— Î™Î£Î¤ÎŸÎ¡Î™ÎšÎŸÎ¥ Î‘Î ÎŸ SUPABASE ÎœÎ•Î£Î© Î¤ÎŸÎ¥ BACKEND ---
      useEffect(() => {
        const fetchHistory = async () => {
          try {
            const res = await fetch(API_BASE_URL);
            const data = await res.json();
            if (data.history && data.history.length > 0) {
              const loadedMessages = data.history.map(m => ({
                sender: m.role === "user" ? "user" : "bot",
                text: m.content
              }));
              setMessages(loadedMessages);
            } else {
              setMessages([{ sender: "bot", text: "Î“ÎµÎ¹Î±! Î”ÎµÎ½ Î²ÏÎ®ÎºÎ± Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î± Î¼Î·Î½ÏÎ¼Î±Ï„Î±. Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰;" }]);
            }
          } catch (err) {
            console.error("Error loading history:", err);
            setMessages([{ sender: "bot", text: "ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸ÎµÏ‚! (Î¤Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ Î±Ï…Ï„Î® Ï„Î· ÏƒÏ„Î¹Î³Î¼Î®)" }]);
          } finally {
            setIsLoadingHistory(false);
          }
        };
        fetchHistory();
      }, []);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [messages]);

      const sendMessage = async () => {
        if (!input.trim() || isTyping) return;
        const userMsg = { sender: "user", text: input };
        setMessages(prev => [...prev, userMsg]);
        const currentInput = input;
        setInput("");
        setIsTyping(true);

        try {
          const response = await fetch(`${API_BASE_URL}/api/chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: currentInput })
          });
          const data = await response.json();
          setMessages(prev => [...prev, { sender: "bot", text: data.reply }]);
        } catch (error) {
          setMessages(prev => [...prev, { sender: "bot", text: "âŒ Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚!" }]);
        } finally {
          setIsTyping(false);
        }
      };

      const clearChat = async () => {
        if(!confirm("Î˜Î­Î»ÎµÎ¹Ï‚ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÏƒÎ²Î®ÏƒÎµÎ¹Ï‚ ÏŒÎ»Î¿ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·;")) return;
        try {
          await fetch(`${API_BASE_URL}/api/clear`, { method: 'POST' });
          setMessages([{ sender: "bot", text: "Î¤Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ!" }]);
        } catch (e) { alert("Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®."); }
      };

      return (
        <React.Fragment>
          <button className="clear-btn" onClick={clearChat}>
            ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎœÎ½Î®Î¼Î·Ï‚ (Supabase)
          </button>
          
          <div id="chat-container">
            <div style={{ padding: '15px', background: '#0084ff', color: 'white', textAlign: 'center', fontWeight: 'bold' }}>
              Python AI Chat (Persistent)
            </div>
            
            <div id="messages-area">
              {isLoadingHistory ? (
                <div style={{textAlign: 'center', color: '#999', marginTop: '20px'}}>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï...</div>
              ) : (
                messages.map((msg, index) => (
                  <div key={index} className={`message ${msg.sender}`}>
                    {msg.sender === "bot" && index === messages.length - 1 && !isLoadingHistory ? (
                      <TypewriterText text={msg.text} />
                    ) : (
                      msg.text
                    )}
                  </div>
                ))
              )}
              <div ref={messagesEndRef} />
            </div>
            
            <div id="input-area">
              <input 
                value={input} 
                disabled={isTyping || isLoadingHistory}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                placeholder={isTyping ? "Î ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ..." : "ÎœÎ®Î½Ï…Î¼Î±..."}
              />
              <button className="send-btn" onClick={sendMessage} disabled={isTyping || !input.trim() || isLoadingHistory}>
                {isTyping ? "..." : "Î£Ï„ÎµÎ¯Î»Îµ"}
              </button>
            </div>
          </div>
        </React.Fragment>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>